from Crypto.Util.number import getStrongPrime, inverse, GCD, bytes_to_long, long_to_bytes
import string, random, hashlib

memory_file = open("corrupted_memory", "wb")
message = open("intercepted_message", 'w')

FLAG = b"L30n4rd_P0w3r_Pl4nt_1s_0n_F1r3!"

def garbage(file, n) :
    alphabet = list(string.printable)[:-6]
    for k in range(1,n+1) :
        if 0.05 > random.random() :
            file.write(random.choice(alphabet).encode('ascii'))
        else :
            file.write(bytes(1))
        if k%32 == 0 :
            file.write('\n'.encode('ascii'))
    if n%32 :
        file.write('\n'.encode('ascii'))

def void(file, n) :
    for k in range(1,n+1) :
        file.write(bytes(1))
        if k%32 == 0 :
            file.write('\n'.encode('ascii'))

def corruption(binary : str, corrupted = 0.25) :
    res = ""
    start = binary.find('1')
    for b in binary[:start//2] :
        if random.random() < corrupted :
            res += '0' if b == '1' else '1'
        else :
            res += b
    res += '1' # previous bits on the 1st byte are altered for sure
    for b in binary[start//2+1:] :
        if random.random() < corrupted :
            res += '0' if b == '1' else '1'
        else :
            res += b
    return res

e = 0x10001
"""
while True:
    for k in range(5):
        p = getStrongPrime(2048)
        q = getStrongPrime(2048)
        phi = (p-1)*(q-1)
        d = inverse(e, phi)
    if d > 1 and GCD(e, phi) == 1 and d*e//phi > e//2:
        break
"""
p = 27836448638585867649333068100942976220006301565052550802379210040385591955450913166644955716335041589477930692821841039905913983491677502230815379048823820975259271042423710540613614205729075317182133409090078279102979304803433246886507780403094972446287307884321778687151801675651684117514721065762193819884770404285365741650070894260909803427262867278099209086434137282938805594183377357642550376846415123004522757116146518193901222573306789348640466055248427879732029357054513870791130512156622426359883881975560311621107561704274687777222149641373852957433784936192604760316525068699329406431884071541679354674957
q = 32088482871009956278751271639250175338097763633028977943484619695989123033102642390427275660908105607068285272438039888811487947019822402410872965223312163595541416919101545729043629661218855793273165934603315524800120756981730419835284706175260199450878469717053262543698915734250435241356889203907154048173840131349951012241637003201180230064827081817485604291315255122507172774945355993268704346107305248787035401644405676021333555873546506926666944382389478457228214032880754675793824756387390827897277965925072553077684744505441816208958887925419164167739488338327649876273661364332251928841647785452791491167149
N = q*p
d = 768002559788889369293989904249834972308780823115017085717628856287440521656280572459218221508745170536658971263358475163121601733088258016887659446193831274078032569743163318667509350883503439884946536897503536768296619543317880079802782019642234816085778150673954087515207994379320694336357091157654121439367841477454543113262670065231099862232480841787349859074659150109092442805323277095683222795072990109480955987471538235039893777410866710794982669219621699214807485869284339731091811776716052020488601353896193130156855931601902963854423204533894318785613728350594022336411584433332612058221505654447298470495013890240096024139177611252404989868212721386561817916992669156852454509294671553109464745229619779615884509254123254073669851885295205824593124406691393014185159656069049330498330904350076590502673015074289887899300723396538328893952455133946767728090178789401024218452774405267033887012212444185416318464286490548908704306690273433682109393618201453213664388851498011975906622805158506510810645997832001442258164116745836171658138565936138772177791100940324202504487833287506889119481795940959807604494967240096624282659336570344412878893965558758143405763230574427920366807486993638654229124247496708305966715716049
ct = pow(bytes_to_long(FLAG),e,N)

"""
mix_order = ""
d2 = bin(d ^ int(bin(d)[2:][::-1],2))[2:].zfill(4096)
while(len(mix_order)//2+1 != 11) :
    mix_order = ""
    d2_blocs = [d2[k*4096//8:(k+1)*4096//8] for k in range(8)]
    d2_mixed_up = [None] * 8
    while None in d2_mixed_up :
        r = random.randint(0,7)
        if d2_mixed_up[r] :
            r = random.randint(0,7)
        if not d2_mixed_up[r] :
            d2_mixed_up[r] = d2_blocs.pop()
        mix_order += '-'+str(r) if mix_order else str(r)
    d2_mixed_up = "".join(d2_mixed_up)
"""
d2 = "0011011111000010000110001000000110000011101000001101011111000110001011101000010000000000110011100110111100111111010101000111000110110100101110010100100100001111100000100101111001000110001010000100111101110010001101001110110101110010100101111111001111010111110110110001000100101010010110100010110101000111010000101001110100111111100001000101100011011001110000001110111001110010000000110001000000000010011001010001100100010001000110110001000000101011110011011011111111000111000001011110011000001010110110000001101110111011010001010111110110110100100000100101010010000011111101111000110011101001100010000110101010001111001101000000000001100011000101100011100100100000010100100011001011010000001011101100000001110011110011000100111111010110100010000010101101110111101011100101001000000011100001101100010011101111110110111001011000100111001000101011000000000011011111101000011100100110101100101111100111101101001010011011110111110001100000010111010000010011010111101011011111010100101101000011110001110110001011111111110101000100100010111111010111101110001010000010110011100111011000010101110011001010111001110111110010110111110110101010010111011010111101101100000111010101100010011111010011000100011010011011101110101001111111100100000101110010110000110110100000010000001011001110000100100000101001001110110000011001010010000100100100101110110110001001100100101101101110011110100011011111010010111111001111100000010100101111100001110100010110100011110101000100101010010010100101100011110101100100101111010011011001110101010101000011110010110010011010100001100100011100011111111100101110110101000001101010101001001001110100100010011111101110011100101100110101110000100111101101001111100100110011101100101111100100100111000110101001001110100001001010000100000010100010110011001100010001001110110101110111000100010000110010101101010100010001111001010100101100010010000010111111111011110010010110011101011101011001011100011011110100000111111111001110100110111110001111111100110101100000100000000110001000111000100010111110011110110100001000111010111011111111111101110101110001000010110111100111110100010001110001000110000000010000011010110011111111000111110110010111001111111110000010111101100011101001101011101011100110100100111101111111110100000100100011010010101001111000100010101011010100110000100010001110111010110111001000100011001100110100010100000010000101001000010111001001010110001110010010011111010011011100110010011111001011011110010000111010110011010011100111011111100100010010111001001001010101011000001010110111010011111111100011100010011000010101100100110100111100001010101010111001101100101111010010011010111100011010010100100101010010001010111100010110100010111000011111010010100000011111001111110100101111101100010111100111011011010010011001000110110111010010010010000100101001100000110111001001010000010010000111001101000000100000010110110000110100111010000010011111111001010111011101100101100010001100101111100100011010101110000011011011110101101110100101010110111110110100111110111001110101001100111010100001101110011100110100000101000111011110101111110100010010001010111111111101000110111000111100001011010010101111101101011110101100100000101110100000011000111110111101100101001011011110011111010011010110010011100001011111101100000000001101010001001110010001101001110110111111011100100011011000011100000001001010011101011110111011010100000100010110101111110010001100111100111000000011011101000000101101001100010010100000010010011100011010001100011000000000001011001111000101010110000100011001011100110001111011111100000100101010010000010010110110111110101000101101110111011000000110110101000001100111101000001110001111111101101100111101010000001000110110001000100010011000101001100100000000001000110000000100111001110111000000111001101100011010001000011111110010111001010000101110001010110100010110100101010010001000110110111110101111001111111010010100111010110111001011000100111011110010000101000110001001111010010000011111000010010010100111010010110110001110001010101111110011110110011100110000000000100001011101000110001111101011000001011100000110000001000110000100001111101100"
d2_mixed_up = "0011011111000010000110001000000110000011101000001101011111000110001011101000010000000000110011100110111100111111010101000111000110110100101110010100100100001111100000100101111001000110001010000100111101110010001101001110110101110010100101111111001111010111110110110001000100101010010110100010110101000111010000101001110100111111100001000101100011011001110000001110111001110010000000110001000000000010011001010001100100010001000110110001000000101011110011011011111111000111000001011110011000001010110110000001101100100010101111111111010001101110001111000010110100101011111011010111101011001000001011101000000110001111101111011001010010110111100111110100110101100100111000010111111011000000000011010100010011100100011010011101101111110111001000110110000111000000010010100111010111101110110101000001000101101011111100100011001111001110000000110111010000001011010011000100101000000100100111000110100011000110000000000010110011110001010101100001000110010111001100011110111111000001001010100100000100101101101111101010001011011101111111011101011100010000101101111001111101000100011100010001100000000100000110101100111111110001111101100101110011111111100000101111011000111010011010111010111001101001001111011111111101000001001000110100101010011110001000101010110101001100001000100011101110101101110010001000110011001101000101000000100001010010000101110010010101100011100100100111110100110111001100100111110010110111100100001110101100110100111001110111111001000100101110010010010101010110000010101101110100111111111000111000100110000101011001001101100000011011010100000110011110100000111000111111110110110011110101000000100011011000100010001001100010100110010000000000100011000000010011100111011100000011100110110001101000100001111111001011100101000010111000101011010001011010010101001000100011011011111010111100111111101001010011101011011100101100010011101111001000010100011000100111101001000001111100001001001010011101001011011000111000101010111111001111011001110011000000000010000101110100011000111110101100000101110000011000000100011000010000111110110010111011010001010111110110110100100000100101010010000011111101111000110011101001100010000110101010001111001101000000000001100011000101100011100100100000010100100011001011010000001011101100000001110011110011000100111111010110100010000010101101110111101011100101001000000011100001101100010011101111110110111001011000100111001000101011000000000011011111101000011100100110101100101111100111101101001010011011110111110001100000010111010000010011010111101011011111010100101101000011110001110110001011111111110101000100001001101010000110010001110001111111110010111011010100000110101010100100100111010010001001111110111001110010110011010111000010011110110100111110010011001110110010111110010010011100011010100100111010000100101000010000001010001011001100110001000100111011010111011100010001000011001010110101010001000111100101010010110001001000001011111111101111001001011001110101110101100101110001101111010000011111111100111010011011111000111111110011010110000010000000011000100011100010001011111001111011010000100011101011101111111000101111110101111011100010100000101100111001110110000101011100110010101110011101111100101101111101101010100101110110101111011011000001110101011000100111110100110001000110100110111011101010011111111001000001011100101100001101101000000100000010110011100001001000001010010011101100000110010100100001001001001011101101100010011001001011011011100111101000110111110100101111110011111000000101001011111000011101000101101000111101010001001010100100101001011000111101011001001011110100110110011101010101010000111100101111010011110000101010101011100110110010111101001001101011110001101001010010010101001000101011110001011010001011100001111101001010000001111100111111010010111110110001011110011101101101001001100100011011011101001001001000010010100110000011011100100101000001001000011100110100000010000001011011000011010011101000001001111111100101011101110110010110001000110010111110010001101010111000001101101111010110111010010101011011111011010011111011100111010100110011101010000110111001110011010000010100011101111010111111010001"
mix_order = "3-1-7-2-3-5-6-4-1-3-0"
mix_protection_hash = hashlib.md5()
mix_protection_hash.update(mix_order.encode('ascii'))

message.write(str(N)+'\n'+str(e)+'\n'+str(ct)+'\n'+d2_mixed_up+'\n'+"{}:{}\n".format(len(mix_order)//2+1, mix_protection_hash.hexdigest()))

corrupted_d = bin(d)[2:]
corrupted_d = '0'*(7-(len(corrupted_d)-1)%8) + corrupted_d
corrupted_d = hex(int(corruption(corrupted_d),2))[2:]
corrupted_d = '0'*(1-(len(corrupted_d)-1)%2) + corrupted_d
corrupted_d = ':'.join([corrupted_d[k-2:k] for k in range(len(corrupted_d),0,-2)][::-1])

garbage(memory_file, 311)
for k in range((len(corrupted_d)-1)//(3*16)+1) :
    memory_file.write((corrupted_d[3*16*k:3*16*(k+1)]+'\n').encode('ascii'))
garbage(memory_file, 199)
garbage(memory_file, 149)
garbage(memory_file, 299)
